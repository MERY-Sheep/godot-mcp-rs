# Godot MCP Server ロードマップ 🚀

## Vision（なぜ作るのか）

### ペルソナ

**プログラミング経験がないが、AI と協力してゲームを作りたい人**

- Godot を使ったことがない
- コードを自分で書けない
- でも大規模なオンラインゲームを作りたい
- AI に設計を伝えて、すべて書いてもらっている

### 目標

**AI Agent が Godot を「自律的に」操作し、ユーザーの指示から完成したシーン/機能を作り上げる**

```
ユーザー：「ログイン画面作って」
    ↓
AI Agent（自律的に動く）
    ├── シーン構造を設計
    ├── UI ノードを配置
    ├── スクリプトを書く
    ├── 実行してテスト
    ├── エラーが出たら自分で修正 ← ここが重要
    └── 「できました」と報告
    ↓
完成したログイン画面
```

### 提供価値

| 価値                             | 説明                                  |
| :------------------------------- | :------------------------------------ |
| **自律的なエラー修正**           | AI がエラーを検知し、自分で修正できる |
| **ユーザーは「何を作るか」だけ** | 「どう作るか」は AI が判断            |
| **プログラミング知識不要**       | コードを読めなくてもゲーム開発が可能  |
| **学習支援**                     | シェーダーの書き方など、お手本を提示  |

---

## 現在のステータス

| 指標                 | 現状                                                                 |
| :------------------- | :------------------------------------------------------------------- |
| MCP 公開ツール数     | **3** (`godot_query`, `godot_mutate`, `godot_introspect`)            |
| CLI/レガシーツール数 | **58** (内部実装、CLI 経由でのみ利用可能)                            |
| 実装言語             | Rust                                                                 |
| リアルタイム操作     | ✅ 対応 (GraphQL ミューテーション経由、または CLI `live-*` ツール群) |
| Undo/Redo 統合       | ✅ 完全対応                                                          |
| エディタープラグイン | ✅ GDScript                                                          |
| CLI モード           | ✅ 対応                                                              |

---

## 🟢 Phase 0: 安全性・運用性の底上げ (Hardening) 🧱

**優先度: 🟢 最優先（短期で効く）** | **目標: 「AI に任せて壊れない」土台を固める**

Phase 1〜3 の機能強化を安心して積み上げるために、まず「入力の安全性」「ログ/デバッグの運用」「仕様と実装の整合」を詰めます。
ここが甘いと、AI が予期せぬ操作（プロジェクト外への書き込み等）や、原因追跡が困難な不具合に遭遇し、自律ループが破綻します。

- [x] **パス検証の共通化（パストラバーサル対策）** ✅ 2025-12

  - **意図**: `res://` などの入力からファイルシステムへ変換する箇所で、`../` 等によるプロジェクト外アクセスを防ぐ（安全境界を明確化）。
  - **狙い**: AI が誤って OS 上の別ファイルを読む/書く事故を防止し、運用環境でも安心して使える状態にする。

- [ ] **引数バリデーションの一貫性（“黙ってデフォルト”を減らす）**

  - **意図**: `unwrap_or_default()` 等で不正入力が成功扱いになり得るパスを減らし、原則 `invalid_params` として明確に失敗させる。
  - **狙い**: AI が「なぜ失敗したか」を理解しやすくし、自己修復（再試行・補正）を安定させる。

- [ ] **ログの整理（`.cursor/debug.log` 直書きの排除 / `tracing` へ統一）**

  - **意図**: 配布物に依存するログ出力・機密混入・性能劣化のリスクを減らし、ログの出力先/粒度を設定で制御できるようにする。
  - **狙い**: MCP 通信（stdout）を汚さず、障害調査もしやすい“運用できる”状態に寄せる。

- [ ] **GraphQL 実行コストの最適化（スキーマ生成のキャッシュ）**

  - **意図**: `godot_query`/`godot_mutate` 実行ごとのスキーマ構築を見直し、必要ならキャッシュ/再利用する。
  - **狙い**: コマンドが増えた時のレスポンス劣化を抑え、AI の反復試行（自律ループ）を高速化する。

- [ ] **ドキュメント整合（“ツール数”の定義と公開範囲の明確化）**
  - **意図**: 「MCP で公開しているツール」と「CLI/レガシー含むツール」の数え方・一覧を分けて記述する。
  - **狙い**: 利用者が“何が MCP から呼べるのか”を誤解しないようにし、オンボーディングコストを下げる。

---

## 🔴 Phase 1: アーキテクチャ刷新 (Refactoring) ⚡

**優先度: 🔴 最高** | **目標: 持続可能な開発基盤の構築**

現状の技術的負債（モノリスなファイル、手動マッピング）を解消し、将来的な拡張性を確保するための基盤再構築を最優先で行います。

- [x] **モノリスの解体**: `resolver.rs` および `command_handler.gd` をドメイン単位（Scene, Script, Project 等）に分割。 ✅ 2025-12
- [x] **動的な型発見 (Dynamic Type Discovery)**: Rust 側での型情報のハードコードを廃止し、Godot エディターへのイントロスペクションで解決する仕組みを導入。 ✅ 2025-12
- [x] **スキーマ駆動開発の強化**: `schema.graphql` と Rust 実装の自動同期検証テストを追加。 ✅ 2025-12
- [x] **WebSocket 移行**: HTTP/SSE から WebSocket に移行し、双方向・低遅延通信を実現。 ✅ 2025-12
- [x] **トランザクション操作**: 複数のミューテーションを一括で適用し、Undo/Redo 単位を LLM の 1 ターンと同期。 ✅ 2025-12
- [x] **エラーハンドリングの構造化**: 詳細なエラーコードとスタックトレースを返却し、AI による自己修復能力を向上。 ✅ 2025-12

---

## 🟠 Phase 2: 開発サイクル支援 (GQL Native) 🔄

**優先度: 🟠 高** | **目標: 実践的なゲーム開発サイクルの統合**

GQL の構造化されたインターフェースを活かし、AI が自律的に機能を実装・検証するループを確立します。

### 2.1 テスト駆動開発 (TDD) 支援

- [x] `mutation runTests` - GdUnit4 等と連携し、テスト結果を構造化データで返却。
- [x] AI が「失敗したテストのみを修正して再実行」するループを確立。

### 2.2 プロジェクト設定 & 入力マップ

- [x] `mutation addInputAction` - InputMap へのアクション・イベント追加。 ✅ 2025-12
- [x] `mutation setProjectSetting` - ProjectSettings の安全な変更。 ✅ 2025-12

### 2.3 国際化 (i18n)

- [x] `mutation addTranslationKey` - 翻訳キーと訳文を管理(CSV/PO)。

---

## 🔴 Phase 3: 高度なデバッグ統合 🐛

**優先度: 🔴 最高** | **目標: AI による完全自動デバッグの実現**

> [!IMPORTANT] > **自律ループの核心**: エラーを検知 → 原因特定 → 修正 → 再実行のサイクルを AI が自力で回せるようにする。
> これがないと「AI に任せて完成」は実現できない。

### 3.1 エラー・ログ情報の構造化取得

- [x] `query debuggerErrors` - スタックトレース付きエラー取得。
- [x] `query logs` - 出力元ファイル・行を含むログ取得。
- [x] `live_get_parse_errors` - スクリプト保存直後の構文エラー検知。 ✅ 2024-12

### 3.2 ブレークポイント & 実行制御

- [x] `mutation setBreakpoint` / `mutation removeBreakpoint`
- [x] `mutation pause` / `mutation resume` / `mutation step`

### 3.3 実行時状態のインスペクション

- [x] `live_get_stack_frame_vars` - スタックフレームのローカル変数取得。 ✅ 2024-12
- [x] `query objectById` - ID を指定したオブジェクトの詳細状態取得。

---

## ✅ Phase 4: コード生成・リファクタリング

**優先度: 🟡 中** | **目標: AI による高度なコード操作** | **完了: 2024-12**

- [x] **コード理解**: クラス階層、シンボル参照検索、オートロード一覧、依存グラフ。
- [x] **リファクタリング**: シンボル名変更、関数抽出、ノードのシーン切り出し。
- [x] **コード生成**: 入力ハンドラー、ステートマシン、テストスクリプトの自動生成。
- [x] **Shader サポート**: シェーダーコードの構文検証、ビジュアルシェーダーのグラフ操作。

---

## 🟡 Phase 5: アセット管理強化 🎨

**優先度: 🟡 中** | **目標: 完全なアセットパイプライン**

- [ ] `create_material` / `create_mesh` - マテリアル・メッシュの生成。
- [ ] `import_asset` - 外部アセットのインポート。
- [ ] `live_set_texture` / `live_set_shader_param` - 実行中の動的変更。
- [ ] **テンプレート拡張**: 車両、NPC (NavMesh)、収集アイテム等の雛形生成。

---

## 🟠 Phase 6: ビジュアル検証システム 🖼️

**優先度: 🟠 高** | **目標: AI による視覚的フィードバックの理解**

> [!NOTE]
> UI 開発を自律的に行うには「見た目の確認」が必須。スクリーンショットを AI が見て判断できるようにする。

- [ ] `live_capture_screenshot` - エディター/実行画面のキャプチャ取得（Base64）。
- [ ] **ビジュアル検証ループ**: スクリーンショットを用いた挙動確認（例: 壁の色、UI の位置）。

---

## ⚪ Phase 7: パフォーマンス分析 & 最適化 📊

**優先度: 低** | **目標: パフォーマンス問題の自動検出**

- [ ] **プロファイリング**: プロファイラーの開始/停止、データ取得。
- [ ] **自動分析**: ドローコール、メモリ使用量、パフォーマンスボトルの検出。

---

## 🟡 Phase 8: 学習支援 📚

**優先度: 🟡 中** | **目標: ユーザーに「お手本」を提示**

> [!TIP]
> シェーダーの組み方が分からない時に、サンプルを見せて学べるようにする。

- [ ] **サンプルコード取得**: Godot 公式ドキュメントや AssetLib からサンプル検索・取得。
- [ ] **テンプレートギャラリー**: よく使うパターン（FPS コントローラー、インベントリ等）のお手本。
- [ ] **シェーダーチュートリアル**: 基本的なシェーダーエフェクトのサンプル生成・解説。
- [ ] **ベストプラクティス提示**: 「この書き方は非推奨」等のアドバイス。

---

## アーキテクチャ改善の短期指針

- [x] **WebSocket 対応**: HTTP からの移行による低遅延化。 ✅ 2024-12
- [ ] **接続プーリング**: 複数コマンドの効率的処理。
- [ ] **Language Server Protocol (LSP) 統合**: 既存の LSP との役割分担と連携。

---

## マイルストーン

| フェーズ | 目標期間 | 主な成果物                     |
| :------- | :------- | :----------------------------- |
| Phase 1  | 3 週間   | アーキテクチャ刷新・基盤再構築 |
| Phase 2  | 2 週間   | 開発サイクル支援 (完全版)      |
| Phase 3  | 3 週間   | 高度なデバッグ統合             |
| Phase 5  | 3 週間   | アセット管理ツール群           |
| Phase 7  | 2 週間   | パフォーマンス分析             |

---

> 💡 **フィードバック歓迎**: このロードマップは開発の進展と技術的な洞察に基づいて常に更新されます。
